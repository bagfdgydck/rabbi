const MAX_CHANGES = 3; // ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ рж╕рж░рзНржмрзЛржЪрзНржЪ рж╕рзАржорж╛

// ржкрзНрж░рждрж┐ржЯрж┐ ржЧрзНрж░рзБржкрзЗрж░ ржЬржирзНржп ржПржмржВ ржкрзНрж░рждрж┐ржЯрж┐ ржЗржЙржЬрж╛рж░-ржПрж░ ржЬржирзНржп ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ рж╕ржВржЦрзНржпрж╛ рж╕рзЗржн ржХрж░рж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржЧрзНрж▓рзЛржмрж╛рж▓ ржЕржмржЬрзЗржХрзНржЯ
global.config.GROUP_CHANGE_TRACKER = global.config.GROUP_CHANGE_TRACKER || {};

module.exports = {
    config: {
        name: "autokick", // ржХржорж╛ржирзНржбрзЗрж░ ржирж╛ржо
        version: "1.0.0",
        credits: "Gemini", // ржлрж╛ржЗрж▓ржЯрж┐ ржЖржорж╛рж░ рждрзИрж░рж┐ ржХрж░рж╛
        hasPermssion: 1, // рж╢рзБржзрзБржорж╛рждрзНрж░ ржЧрзНрж░рзБржк ржЕрзНржпрж╛ржбржорж┐ржи ржмрж╛ ржмржЯ ржЕрзНржпрж╛ржбржорж┐ржи ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
        commandCategory: "Group",
        usages: "autokick status | autokick reset @ржЗржЙржЬрж╛рж░",
        cooldowns: 5
    },

    // ------------------------------------------------
    // Command Function (рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржжрзЗржЦрж╛ ржУ рж░рж┐рж╕рзЗржЯ ржХрж░рж╛рж░ ржЬржирзНржп)
    // ------------------------------------------------
    run: function ({ api, event, args, global }) {
        let threadID = event.threadID;
        let tracker = global.config.GROUP_CHANGE_TRACKER[threadID];

        if (args[0]?.toLowerCase() === "status") {
            if (!tracker || Object.keys(tracker).length === 0) {
                return api.sendMessage("ржПржЗ ржЧрзНрж░рзБржкрзЗ ржПржЦржирзЛ ржХрзЗржЙ ржирж╛ржо ржмрж╛ ржЫржмрж┐ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзЗржирж┐ред", threadID, event.messageID);
            }

            let statusMessage = "ЁЯСд **ржЧрзНрж░рзБржк ржкрж░рж┐ржмрж░рзНрждржи ржЯрзНрж░рзНржпрж╛ржХрж╛рж░ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕:**\n";
            for (let userID in tracker) {
                let count = tracker[userID];
                // ржЗржЙржЬрж╛рж░-ржПрж░ ржирж╛ржо ржкрзЗрждрзЗ api.getUserInfo ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ ржпрзЗрждрзЗ ржкрж╛рж░рзЗ, ржХрж┐ржирзНрждрзБ ржПржЦрж╛ржирзЗ рж╕рж╣ржЬ рж░рж╛ржЦрждрзЗ ID ржжрзЗржЦрж╛ржЪрзНржЫрж┐
                statusMessage += `- ржЗржЙржЬрж╛рж░ ID: ${userID} | ржкрж░рж┐ржмрж░рзНрждржи: ${count} ржмрж╛рж░\n`;
            }
            api.sendMessage(statusMessage, threadID, event.messageID);
            
        } else if (args[0]?.toLowerCase() === "reset") {
             // ржЯрзНржпрж╛ржЧ ржХрж░рж╛ ржЗржЙржЬрж╛рж░-ржПрж░ ID ржмрзЗрж░ ржХрж░рж╛ (ржпржжрж┐ ржмржЯ ржлрзНрж░рзЗржоржУржпрж╝рж╛рж░рзНржХ ржПржЯрж┐ рж╕рж╛ржкрзЛрж░рзНржЯ ржХрж░рзЗ)
            let userIDToReset = Object.keys(event.mentions)[0];

            if (!userIDToReset) {
                 return api.sendMessage("тЪая╕П рж░рж┐рж╕рзЗржЯ ржХрж░рждрзЗ, ржЖржкржирж╛ржХрзЗ ржЕржмрж╢рзНржпржЗ ржЗржЙржЬрж╛рж░-ржХрзЗ ржЯрзНржпрж╛ржЧ (@) ржХрж░рждрзЗ рж╣ржмрзЗред", threadID, event.messageID);
            }

            if (tracker && tracker[userIDToReset]) {
                delete tracker[userIDToReset];
                api.sendMessage(`тЬЕ ржЗржЙржЬрж╛рж░ ${userIDToReset}-ржПрж░ ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ рж╕ржВржЦрзНржпрж╛ рж╕ржлрж▓ржнрж╛ржмрзЗ рж░рж┐рж╕рзЗржЯ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред`, threadID, event.messageID);
            } else {
                 api.sendMessage("тЪая╕П ржПржЗ ржЗржЙржЬрж╛рж░-ржПрж░ ржХрзЛржирзЛ ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ рж╣рж┐рж╕рзЗржм ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред", threadID, event.messageID);
            }

        } else {
            api.sendMessage(
                `ржмрзНржпржмрж╣рж╛рж░:\n` +
                `1. /autokick status: ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ рж╣рж┐рж╕рзЗржм ржжрзЗржЦрзБржиред\n` +
                `2. /autokick reset @ржЗржЙржЬрж╛рж░: ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржЗржЙржЬрж╛рж░-ржПрж░ рж╣рж┐рж╕рзЗржм рж░рж┐рж╕рзЗржЯ ржХрж░рзБржиред\n` +
                `ржирзЛржЯ: рждрж┐ржиржмрж╛рж░ ржирж╛ржо/ржЫржмрж┐ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж▓рзЗ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ ржЗржЙржЬрж╛рж░-ржХрзЗ ржХрж┐ржХ ржХрж░рж╛ рж╣ржмрзЗред`, 
                threadID, event.messageID
            );
        }
    },

    // ------------------------------------------------
    // Event Handler (ржорзВрж▓ рж▓ржЬрж┐ржХ)
    // ------------------------------------------------
    Event: async function ({ api, event, global }) {
        let threadID = event.threadID;
        let authorID = event.author; // ржкрж░рж┐ржмрж░рзНрждржиржХрж╛рж░рзА ржЗржЙржЬрж╛рж░-ржПрж░ ID

        // рж╢рзБржзрзБржорж╛рждрзНрж░ ржирж╛ржо ржмрж╛ ржЫржмрж┐ ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ ржЗржнрзЗржирзНржЯржЧрзБрж▓рзЛ ржЪрзЗржХ ржХрж░рж╛ рж╣ржмрзЗ
        if (event.logMessageType === "log:threadName" || event.logMessageType === "log:threadImage") {
            // ржпржжрж┐ bot ржирж┐ржЬрзЗржЗ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзЗ, рждржмрзЗ рж╣рж┐рж╕рзЗржм рж░рж╛ржЦрж╛ рж╣ржмрзЗ ржирж╛
            if (authorID === api.getCurrentUserID()) return;

            // ржпржжрж┐ ржПржЗ ржЧрзНрж░рзБржкрзЗрж░ ржЬржирзНржп ржЯрзНрж░рзНржпрж╛ржХрж╛рж░ ржЕржмржЬрзЗржХрзНржЯ рждрзИрж░рж┐ ржирж╛ рж╣рзЯрзЗ ржерж╛ржХрзЗ, рждржмрзЗ рждрзИрж░рж┐ ржХрж░рж╛
            if (!global.config.GROUP_CHANGE_TRACKER[threadID]) {
                global.config.GROUP_CHANGE_TRACKER[threadID] = {};
            }

            let tracker = global.config.GROUP_CHANGE_TRACKER[threadID];
            
            // ржЗржЙржЬрж╛рж░-ржПрж░ ржХрж╛ржЙржирзНржЯ ржмрзГржжрзНржзрж┐ ржХрж░рж╛
            tracker[authorID] = (tracker[authorID] || 0) + 1;
            let currentCount = tracker[authorID];

            // тЪая╕П ржХрж┐ржХ ржХрж░рж╛рж░ рж╢рж░рзНржд ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рж╛
            if (currentCount >= MAX_CHANGES) {
                try {
                    // ржЗржЙржЬрж╛рж░-ржПрж░ рждржерзНржп (ржирж╛ржо) ржкрж╛ржУржпрж╝рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛
                    let userInfo = await api.getUserInfo(authorID);
                    let userName = userInfo[authorID].name || "ржПржЗ ржЗржЙржЬрж╛рж░";

                    // ржЗржЙржЬрж╛рж░-ржХрзЗ ржЧрзНрж░рзБржк ржерзЗржХрзЗ ржмрзЗрж░ ржХрж░рзЗ ржжрзЗржУрзЯрж╛
                    await api.removeUserFromGroup(authorID, threadID);

                    // ржЧрзНрж░рзБржкрзЗ ржмрж╛рж░рзНрждрж╛ ржкрж╛ржарж╛ржирзЛ
                    api.sendMessage(
                        `ЁЯЪл ржХрж┐ржХ ржЕрзНржпрж╛ржХрж╢ржи: ${userName} (${authorID}) ржЧрзНрж░рзБржкрзЗ ржирж╛ржо/ржЫржмрж┐ ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ рж╕рзАржорж╛ (${MAX_CHANGES} ржмрж╛рж░) ржЕрждрж┐ржХрзНрж░ржо ржХрж░рзЗржЫрзЗред рждрж╛ржЗ рждрж╛ржХрзЗ ржЧрзНрж░рзБржк ржерзЗржХрзЗ рж░рж┐ржорзБржн ржХрж░рж╛ рж╣рж▓рзЛред`, 
                        threadID
                    );

                    // рж╕ржлрж▓ржнрж╛ржмрзЗ ржмрзЗрж░ ржХрж░рзЗ ржжрзЗржУрзЯрж╛рж░ ржкрж░ ржЗржЙржЬрж╛рж░-ржПрж░ ржХрж╛ржЙржирзНржЯ рж░рж┐рж╕рзЗржЯ ржХрж░рж╛
                    delete tracker[authorID];

                } catch (e) {
                    // ржХрж┐ржХ ржХрж░рждрзЗ ржмрзНржпрж░рзНрже рж╣рж▓рзЗ (ржпрзЗржоржи ржмржЯ ржЕрзНржпрж╛ржбржорж┐ржи ржирж╛ рж╣рж▓рзЗ)
                    api.sendMessage(
                        `тЭМ ржХрж┐ржХ ржмрзНржпрж░рзНрже: ${authorID} рж╕рзАржорж╛ ржЕрждрж┐ржХрзНрж░ржо ржХрж░рзЗржЫрзЗ, ржХрж┐ржирзНрждрзБ ржмржЯ рждрж╛ржХрзЗ рж░рж┐ржорзБржн ржХрж░рждрзЗ ржмрзНржпрж░рзНрже рж╣ржпрж╝рзЗржЫрзЗред (рж╕ржорзНржнржмржд ржмржЯрзЗрж░ ржЕрзНржпрж╛ржбржорж┐ржи ржкрж╛рж░ржорж┐рж╢ржи ржирзЗржЗ) - рждрзНрж░рзБржЯрж┐: ${e.message}`, 
                        threadID
                    );
                    console.error("AutoKick Failed:", e);
                }
            } else {
                // рж╕рзАржорж╛ ржирж╛ ржЫрж╛рзЬрж╛рж▓рзЗ рж╢рзБржзрзБржорж╛рждрзНрж░ рж╕рждрж░рзНржХ ржмрж╛рж░рзНрждрж╛
                let remaining = MAX_CHANGES - currentCount;
                api.sendMessage(
                    `тЪая╕П рж╕рждрж░рзНржХрждрж╛: ржЖржкржирж┐ ${currentCount} ржмрж╛рж░ ржЧрзНрж░рзБржкрзЗрж░ рж╕рзЗржЯрж┐ржВ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзЗржЫрзЗржиред ржЖрж░ ${remaining} ржмрж╛рж░ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж▓рзЗ ржЖржкржирж╛ржХрзЗ ржЧрзНрж░рзБржк ржерзЗржХрзЗ рж░рж┐ржорзБржн ржХрж░рж╛ рж╣ржмрзЗред`, 
                    threadID
                );
            }
        }
    }
};
